---
import Base from "../layouts/Base.astro";
import { event } from "../data/event.js";
---
<Base title={`RSVP | ${event.coupleNames}`}>
  <section class="card">
    <h2 class="section-title section-title--plain">RSVP</h2>
    <p>Please reply by {event.rsvpDeadline}. We will send a confirmation email right away.</p>

    <form id="rsvp-form">
      <div>
        <label for="name">Full name</label>
        <input id="name" name="name" type="text" autocomplete="name" required />
      </div>
      <div>
        <label for="email">Email</label>
        <input id="email" name="email" type="email" autocomplete="email" required />
      </div>
      <div>
        <label>Will you attend?</label>
        <div class="attendance-toggle">
          <label class="toggle-option">
            <input type="radio" name="attending" value="yes" />
            <span class="toggle-label">Yes, I'll be there</span>
          </label>
          <label class="toggle-option">
            <input type="radio" name="attending" value="no" />
            <span class="toggle-label">Sorry, can't make it</span>
          </label>
        </div>
      </div>
      <div>
        <label for="dietaryNotes">Dietary notes</label>
        <input id="dietaryNotes" name="dietaryNotes" type="text" placeholder="Vegetarian, allergies, etc." />
      </div>
      <div>
        <label for="message">Message for the couple</label>
        <textarea id="message" name="message"></textarea>
      </div>
      <button class="button" type="submit">Send RSVP</button>
      <div id="rsvp-status" role="status" aria-live="polite"></div>
    </form>

    <div id="rsvp-success" class="success" hidden>
      <h3 style="margin-top: 0;">RSVP received</h3>
      <p>Check your email for the confirmation and your private update link.</p>
      <div id="rsvp-edit-link" style="margin: 12px 0;"></div>
      <div class="list" style="margin-top: 16px;">
        <div>
          <strong>Date:</strong> {event.date}
        </div>
        <div>
          <strong>Time:</strong> {event.startTime} to {event.endTime} ({event.timezone})
        </div>
        <div>
          <strong>Venue:</strong> {event.venue.name}, {event.venue.address}
        </div>
      </div>
      <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
        <a class="button terracotta" href={event.venue.mapUrl} target="_blank" rel="noreferrer">Map link</a>
        <a class="button secondary" href="/wedding.ics">Add to calendar</a>
      </div>
    </div>
  </section>

  <script is:inline>
    const form = document.querySelector("#rsvp-form");
    const statusEl = document.querySelector("#rsvp-status");
    const successEl = document.querySelector("#rsvp-success");
    const editLinkEl = document.querySelector("#rsvp-edit-link");

    function setStatus(message, type = "notice") {
      statusEl.className = type === "success" ? "success" : "notice";
      statusEl.textContent = message;
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      const data = new FormData(form);
      const attendingValue = data.get("attending");
      if (!attendingValue) {
        setStatus("Please select yes or no.", "error");
        return;
      }

      const attending = attendingValue === "yes";

      const payload = {
        name: String(data.get("name") || "").trim(),
        email: String(data.get("email") || "").trim(),
        attending,
        dietaryNotes: String(data.get("dietaryNotes") || "").trim(),
        message: String(data.get("message") || "").trim()
      };

      if (!payload.name || !payload.email) {
        setStatus("Name and email are required.", "error");
        return;
      }

      setStatus("Sending your RSVP...", "notice");

      try {
        const response = await fetch("/.netlify/functions/rsvp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.error || "Unable to send RSVP.");
        }

        form.setAttribute("hidden", "true");
        successEl.removeAttribute("hidden");
        statusEl.setAttribute("hidden", "true");

        if (result.editUrl) {
          editLinkEl.innerHTML = `<a class="button secondary" href="${result.editUrl}">Update your RSVP</a>`;
        }
      } catch (error) {
        setStatus(error.message, "error");
      }
    });
  </script>
</Base>
